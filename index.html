<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ICT Closed Tickets Analytics Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        * { 
            box-sizing: border-box; 
            margin: 0; 
            padding: 0; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
        }
        
        body { 
            background: linear-gradient(135deg, #f5f7fa 0%, #e4edf5 100%);
            color: #333;
            padding: 20px;
            min-height: 100vh;
        }
        
        .dashboard-container {
            max-width: 1800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        .dashboard-header {
            background: linear-gradient(to right, #2c5282, #4a6fa5);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .dashboard-header h1 {
            font-size: 2.2rem;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }
        
        .dashboard-header p {
            font-size: 1.1rem;
            opacity: 0.9;
            max-width: 800px;
            margin: 0 auto;
            line-height: 1.6;
        }
        
        .stats-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            padding: 25px;
            background: #f8fafc;
        }
        
        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            display: flex;
            align-items: center;
            gap: 15px;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
        }
        
        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }
        
        .stat-content h3 {
            font-size: 1.1rem;
            color: #64748b;
            margin-bottom: 5px;
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: #2c5282;
        }
        
        .stat-subtitle {
            font-size: 0.9rem;
            color: #94a3b8;
        }
        
        .charts-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 25px;
            padding: 25px;
        }
        
        /* NEW: Personnel Performance Section */
        .personnel-section {
            padding: 25px;
            background: #f8fafc;
            margin-top: 10px;
        }
        
        .personnel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e2e8f0;
        }
        
        .personnel-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #2c5282;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .personnel-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .personnel-filter {
            padding: 8px 15px;
            border: 1px solid #cbd5e0;
            border-radius: 6px;
            background: white;
            font-size: 0.9rem;
        }
        
        .personnel-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
        }
        
        .personnel-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            border: 1px solid #e2e8f0;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .personnel-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        
        .personnel-card-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #f1f5f9;
        }
        
        .personnel-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 1.2rem;
        }
        
        .personnel-info h3 {
            font-size: 1.2rem;
            color: #2c5282;
            margin-bottom: 5px;
        }
        
        .personnel-info p {
            font-size: 0.9rem;
            color: #64748b;
        }
        
        .personnel-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .personnel-stat {
            text-align: center;
            padding: 10px;
            background: #f7fafc;
            border-radius: 8px;
        }
        
        .personnel-stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #2c5282;
            margin-bottom: 5px;
        }
        
        .personnel-stat-label {
            font-size: 0.85rem;
            color: #718096;
        }
        
        .personnel-performance-bar {
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 5px;
        }
        
        .personnel-performance-fill {
            height: 100%;
            border-radius: 4px;
        }
        
        .personnel-rating {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }
        
        .stars {
            color: #f6ad55;
            font-size: 0.9rem;
        }
        
        .personnel-chart-mini {
            height: 60px;
            margin-top: 15px;
        }
        
        .personnel-tickets {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #f1f5f9;
            font-size: 0.85rem;
            color: #718096;
        }
        
        /* NEW: Top Performers Summary */
        .top-performers {
            grid-column: 1 / -1;
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            margin-top: 20px;
        }
        
        .top-performers-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .top-performers-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #2c5282;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .performance-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .performance-table th {
            text-align: left;
            padding: 12px 15px;
            background: #f7fafc;
            color: #4a5568;
            font-weight: 600;
            border-bottom: 2px solid #e2e8f0;
        }
        
        .performance-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #edf2f7;
        }
        
        .performance-table tr:hover {
            background: #f7fafc;
        }
        
        .rank {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #4a6fa5;
            color: white;
            font-weight: bold;
            font-size: 0.8rem;
        }
        
        .rank-1 { background: linear-gradient(135deg, #f6e05e, #d69e2e); }
        .rank-2 { background: linear-gradient(135deg, #cbd5e0, #a0aec0); }
        .rank-3 { background: linear-gradient(135deg, #ed8936, #c05621); }
        
        .rating-badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        .rating-excellent { background: #c6f6d5; color: #22543d; }
        .rating-good { background: #fed7d7; color: #742a2a; }
        .rating-average { background: #feebc8; color: #744210; }
        .rating-poor { background: #e2e8f0; color: #2d3748; }
        
        /* Existing chart styles... */
        .chart-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            border: 1px solid #e2e8f0;
        }
        
        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f1f5f9;
        }
        
        .chart-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #2c5282;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .chart-subtitle {
            color: #64748b;
            font-size: 0.95rem;
        }
        
        .chart-container {
            height: 300px;
            position: relative;
        }
        
        .legend {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #f1f5f9;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
        }
        
        .legend-color {
            width: 15px;
            height: 15px;
            border-radius: 3px;
        }
        
        .tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px 15px;
            border-radius: 5px;
            font-size: 0.9rem;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 100;
        }
        
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px;
            color: #64748b;
            text-align: center;
        }
        
        .loading-spinner {
            font-size: 3rem;
            margin-bottom: 20px;
            color: #4a6fa5;
        }
        
        .error-message {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px;
            color: #e53e3e;
            text-align: center;
        }
        
        .refresh-btn {
            background: #4a6fa5;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 1rem;
            margin-top: 20px;
            transition: background 0.3s;
        }
        
        .refresh-btn:hover {
            background: #2c5282;
        }
        
        .dashboard-footer {
            text-align: center;
            padding: 20px;
            color: #94a3b8;
            font-size: 0.9rem;
            border-top: 1px solid #e2e8f0;
        }
        
        /* Responsive adjustments */
        @media (max-width: 1200px) {
            .charts-container {
                grid-template-columns: 1fr;
            }
            .personnel-grid {
                grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            }
        }
        
        @media (max-width: 768px) {
            .dashboard-header h1 {
                font-size: 1.8rem;
            }
            
            .charts-container {
                padding: 15px;
            }
            
            .chart-card {
                padding: 15px;
            }
            
            .chart-container {
                height: 250px;
            }
            
            .personnel-section {
                padding: 15px;
            }
            
            .personnel-grid {
                grid-template-columns: 1fr;
            }
            
            .personnel-header {
                flex-direction: column;
                gap: 15px;
                align-items: flex-start;
            }
            
            .personnel-controls {
                width: 100%;
                justify-content: space-between;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <div class="dashboard-header">
            <h1><i class="fas fa-chart-line"></i> ICT Closed Tickets Analytics Dashboard</h1>
            <p>Comprehensive analysis of resolved ICT service requests with insights into demographics, response times, and performance metrics</p>
        </div>
        
        <div class="stats-summary" id="statsSummary">
            <!-- Stats will be populated by JavaScript -->
        </div>
        
        <!-- NEW: Personnel Performance Section -->
        <div class="personnel-section" id="personnelSection" style="display: none;">
            <div class="personnel-header">
                <div class="personnel-title">
                    <i class="fas fa-user-tie"></i> Personnel Performance Analytics
                </div>
                <div class="personnel-controls">
                    <div>
                        <span style="font-size: 0.9rem; color: #64748b; margin-right: 10px;">Sort by:</span>
                        <select class="personnel-filter" id="sortPersonnel">
                            <option value="rating-desc">Highest Rating First</option>
                            <option value="rating-asc">Lowest Rating First</option>
                            <option value="response-asc">Fastest Response First</option>
                            <option value="response-desc">Slowest Response First</option>
                            <option value="tickets-desc">Most Tickets First</option>
                            <option value="tickets-asc">Fewest Tickets First</option>
                        </select>
                    </div>
                    <div>
                        <span style="font-size: 0.9rem; color: #64748b; margin-right: 10px;">Show:</span>
                        <select class="personnel-filter" id="filterPersonnel">
                            <option value="all">All Personnel</option>
                            <option value="top10">Top 10 Performers</option>
                            <option value="top20">Top 20 Performers</option>
                            <option value="rating4">Rating 4.0+</option>
                            <option value="rating3">Rating 3.0-3.9</option>
                            <option value="rating2">Rating Below 3.0</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div class="personnel-grid" id="personnelGrid">
                <!-- Personnel cards will be populated by JavaScript -->
            </div>
            
            <div class="top-performers" id="topPerformers">
                <div class="top-performers-header">
                    <div class="top-performers-title">
                        <i class="fas fa-trophy"></i> Top Performers Summary
                    </div>
                    <div style="font-size: 0.9rem; color: #64748b;">
                        Showing <span id="personnelCount">0</span> personnel members
                    </div>
                </div>
                
                <table class="performance-table" id="performanceTable">
                    <thead>
                        <tr>
                            <th style="width: 60px;">Rank</th>
                            <th>Personnel Name</th>
                            <th style="width: 100px;">Avg Rating</th>
                            <th style="width: 150px;">Avg Response Time</th>
                            <th style="width: 100px;">Total Tickets</th>
                            <th style="width: 120px;">Performance Category</th>
                        </tr>
                    </thead>
                    <tbody id="performanceTableBody">
                        <!-- Table rows will be populated by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
        
        <div class="charts-container">
            <!-- Chart 1: Demographics (Age & Gender) -->
            <div class="chart-card">
                <div class="chart-header">
                    <div>
                        <div class="chart-title"><i class="fas fa-users"></i> Demographics Overview</div>
                        <div class="chart-subtitle">Age distribution and sex breakdown of talent</div>
                    </div>
                </div>
                <div class="chart-container" id="demographicsChart"></div>
                <div class="legend" id="demographicsLegend"></div>
            </div>
            
            <!-- Chart 2: Regulation Area Distribution -->
            <div class="chart-card">
                <div class="chart-header">
                    <div>
                        <div class="chart-title"><i class="fas fa-sitemap"></i> Regulation Areas</div>
                        <div class="chart-subtitle">Distribution of tickets across regulation areas</div>
                    </div>
                </div>
                <div class="chart-container" id="regulationChart"></div>
                <div class="legend" id="regulationLegend"></div>
            </div>
            
            <!-- Chart 3: Problem Types -->
            <div class="chart-card">
                <div class="chart-header">
                    <div>
                        <div class="chart-title"><i class="fas fa-exclamation-triangle"></i> Problem Types Analysis</div>
                        <div class="chart-subtitle">Most common issues encountered by talent</div>
                    </div>
                </div>
                <div class="chart-container" id="problemChart"></div>
                <div class="legend" id="problemLegend"></div>
            </div>
            
            <!-- Chart 4: Response Time Performance -->
            <div class="chart-card">
                <div class="chart-header">
                    <div>
                        <div class="chart-title"><i class="fas fa-stopwatch"></i> Response Time Analysis</div>
                        <div class="chart-subtitle">Distribution by response time categories</div>
                    </div>
                </div>
                <div class="chart-container" id="responseTimeChart"></div>
                <div class="legend" id="responseTimeLegend"></div>
            </div>
            
            <!-- Chart 5: Performance Ratings -->
            <div class="chart-card">
                <div class="chart-header">
                    <div>
                        <div class="chart-title"><i class="fas fa-star"></i> Performance Ratings</div>
                        <div class="chart-subtitle">Average performance ratings across different categories</div>
                    </div>
                </div>
                <div class="chart-container" id="performanceChart"></div>
                <div class="legend" id="performanceLegend"></div>
            </div>
            
            <!-- Chart 6: Correlation Analysis -->
            <div class="chart-card">
                <div class="chart-header">
                    <div>
                        <div class="chart-title"><i class="fas fa-project-diagram"></i> Correlation Analysis</div>
                        <div class="chart-subtitle">Response time vs. performance rating correlation</div>
                    </div>
                </div>
                <div class="chart-container" id="correlationChart"></div>
                <div class="legend" id="correlationLegend"></div>
            </div>
        </div>
        
        <div id="loading" class="loading">
            <div class="loading-spinner">
                <i class="fas fa-spinner fa-spin"></i>
            </div>
            <h2>Loading Closed Tickets Analytics</h2>
            <p>Fetching and analyzing data from Google Sheets...</p>
        </div>
        
        <div id="error" class="error-message" style="display: none;">
            <div style="font-size: 3rem; margin-bottom: 20px;">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <h2>Unable to Load Analytics Data</h2>
            <p id="errorMessage">Please check your connection and try again.</p>
            <button class="refresh-btn" onclick="loadClosedTicketsData()">
                <i class="fas fa-redo-alt"></i> Try Again
            </button>
        </div>
        
        <div class="dashboard-footer">
            <p>Data Source: ICT Concerns - Closed Tickets Sheet | Last Updated: <span id="lastUpdated"></span></p>
            <p>Analytics Dashboard â€¢ Auto-refreshes every 10 minutes</p>
        </div>
    </div>

    <script>
        // Main data storage
        let closedTicketsData = [];
        let analyticsSummary = {};
        let personnelPerformance = {}; // NEW: Store personnel performance data
        
        // Response time mapping
        const responseTimeMapping = {
            'Less than one (1) hour': { numericValue: 0.5, label: 'Less than 1 hour', description: '<1 hr' },
            'Within the day': { numericValue: 4.5, label: 'Within the day', description: '1-8 hrs' },
            'The next day': { numericValue: 12, label: 'The next day', description: '8-16 hrs' },
            'More than two (2) days': { numericValue: 24, label: 'More than 2 days', description: '>16 hrs' },
            'Less than one hour': { numericValue: 0.5, label: 'Less than 1 hour', description: '<1 hr' },
            'Within the day (1-8 hrs)': { numericValue: 4.5, label: 'Within the day', description: '1-8 hrs' },
            'The next day (8-16 hrs)': { numericValue: 12, label: 'The next day', description: '8-16 hrs' },
            'More than 2 days': { numericValue: 24, label: 'More than 2 days', description: '>16 hrs' },
            'More than two days': { numericValue: 24, label: 'More than 2 days', description: '>16 hrs' }
        };
        
        // Color scales
        const colorScale = d3.scaleOrdinal()
            .range(['#4a6fa5', '#2c5282', '#38a169', '#d69e2e', '#e53e3e', '#805ad5', '#dd6b20', '#319795']);
        
        // Tooltip element
        const tooltip = d3.select('body').append('div')
            .attr('class', 'tooltip')
            .style('opacity', 0);
        
        // Function to convert response time text to numeric value
        function convertResponseTimeToNumeric(responseTimeText) {
            if (!responseTimeText) return 0;
            
            const normalizedText = responseTimeText.trim();
            
            if (responseTimeMapping[normalizedText]) {
                return responseTimeMapping[normalizedText].numericValue;
            }
            
            for (const [key, value] of Object.entries(responseTimeMapping)) {
                if (normalizedText.toLowerCase().includes(key.toLowerCase())) {
                    return value.numericValue;
                }
            }
            
            console.log('Unknown response time category:', normalizedText);
            return 0;
        }
        
        // Function to get response time category info
        function getResponseTimeCategoryInfo(responseTimeText) {
            if (!responseTimeText) return null;
            
            const normalizedText = responseTimeText.trim();
            
            if (responseTimeMapping[normalizedText]) {
                return responseTimeMapping[normalizedText];
            }
            
            for (const [key, value] of Object.entries(responseTimeMapping)) {
                if (normalizedText.toLowerCase().includes(key.toLowerCase())) {
                    return value;
                }
            }
            
            return null;
        }
        
        // NEW: Function to get initials from name
        function getInitials(name) {
            if (!name) return '?';
            const parts = name.split(' ');
            if (parts.length >= 2) {
                return (parts[0][0] + parts[1][0]).toUpperCase();
            }
            return name.substring(0, 2).toUpperCase();
        }
        
        // NEW: Function to get performance category based on rating
        function getPerformanceCategory(rating) {
            if (rating >= 4.5) return { label: 'Excellent', class: 'rating-excellent', stars: 5 };
            if (rating >= 4.0) return { label: 'Very Good', class: 'rating-good', stars: 4 };
            if (rating >= 3.0) return { label: 'Average', class: 'rating-average', stars: 3 };
            if (rating >= 2.0) return { label: 'Below Average', class: 'rating-poor', stars: 2 };
            return { label: 'Poor', class: 'rating-poor', stars: 1 };
        }
        
        // NEW: Function to get stars HTML
        function getStarsHTML(rating) {
            const fullStars = Math.floor(rating);
            const halfStar = rating % 1 >= 0.5;
            const emptyStars = 5 - fullStars - (halfStar ? 1 : 0);
            
            let starsHTML = '';
            for (let i = 0; i < fullStars; i++) {
                starsHTML += '<i class="fas fa-star"></i>';
            }
            if (halfStar) {
                starsHTML += '<i class="fas fa-star-half-alt"></i>';
            }
            for (let i = 0; i < emptyStars; i++) {
                starsHTML += '<i class="far fa-star"></i>';
            }
            return starsHTML;
        }
        
        // NEW: Function to create mini chart for personnel response times
        function createMiniResponseChart(personnelData, containerId) {
            const container = document.getElementById(containerId);
            if (!container || !personnelData.responseTimes || personnelData.responseTimes.length === 0) return;
            
            const width = 200;
            const height = 40;
            const margin = { top: 5, right: 5, bottom: 5, left: 5 };
            
            const svg = d3.select(`#${containerId}`)
                .append('svg')
                .attr('width', width)
                .attr('height', height);
            
            const responseTimes = personnelData.responseTimes.slice(-6); // Last 6 response times
            
            const x = d3.scaleBand()
                .domain(responseTimes.map((d, i) => i))
                .range([margin.left, width - margin.right])
                .padding(0.2);
            
            const y = d3.scaleLinear()
                .domain([0, d3.max(responseTimes)])
                .nice()
                .range([height - margin.bottom, margin.top]);
            
            svg.selectAll('.mini-bar')
                .data(responseTimes)
                .enter()
                .append('rect')
                .attr('class', 'mini-bar')
                .attr('x', (d, i) => x(i))
                .attr('y', d => y(d))
                .attr('width', x.bandwidth())
                .attr('height', d => height - margin.bottom - y(d))
                .attr('fill', d => {
                    if (d < 1) return '#38a169';
                    if (d <= 8) return '#d69e2e';
                    if (d <= 16) return '#ed8936';
                    return '#e53e3e';
                })
                .attr('rx', 2)
                .attr('ry', 2);
        }
        
        // Load data from Google Sheets
        async function loadClosedTicketsData() {
            const loading = document.getElementById('loading');
            const error = document.getElementById('error');
            const statsSummary = document.getElementById('statsSummary');
            const personnelSection = document.getElementById('personnelSection');
            
            loading.style.display = 'flex';
            error.style.display = 'none';
            statsSummary.innerHTML = '';
            personnelSection.style.display = 'none';
            
            try {
                const originalUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSlQLcK_Ktw2zemNHDZ_70giWPqT54Mvoci_dJxQz1RWYhe94UaDQLPQU89DUYLTY-ow7s2sWa-PB0h/pub?gid=1210338777&single=true&output=csv';
                const corsProxy = 'https://api.allorigins.win/raw?url=';
                const csvUrl = corsProxy + encodeURIComponent(originalUrl);
                
                console.log('Loading closed tickets from:', csvUrl);
                
                let response;
                try {
                    response = await fetch(csvUrl);
                } catch (proxyError) {
                    console.log('CORS proxy failed, trying direct access...');
                    response = await fetch(originalUrl);
                }
                
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                
                const csvText = await response.text();
                
                // Parse CSV
                const rows = csvText.split('\n');
                closedTicketsData = [];
                
                // Parse and filter valid rows
                for (let i = 1; i < rows.length; i++) {
                    if (rows[i].trim() === '') continue;
                    
                    const cols = parseCSVRow(rows[i]);
                    
                    // Check if we have the required columns (A-M)
                    if (cols.length >= 13) {
                        // Get personnel name from column J (index 9)
                        const personnelName = cols[9] || '';
                        
                        // Get response time text from column K (index 10)
                        const responseTimeText = cols[10] || '';
                        
                        // Convert response time text to numeric value
                        const responseTimeNumeric = convertResponseTimeToNumeric(responseTimeText);
                        const responseTimeCategory = getResponseTimeCategoryInfo(responseTimeText);
                        
                        // Create ticket object
                        const ticket = {
                            'Personnel': personnelName,           // Column J
                            'Age': cols[3] || '',                // Column D
                            'Sex': cols[4] || '',                // Column E
                            'Regulation Area': cols[6] || '',    // Column G
                            'Problem Encountered': cols[7] || '', // Column H
                            'Response Time Text': responseTimeText, // Column K (text)
                            'Response Time': responseTimeNumeric, // Converted numeric value
                            'Response Time Category': responseTimeCategory, // Category info
                            'Average Performance': parseFloat(cols[12]) || 0 // Column M
                        };
                        
                        // Only add if we have at least some valid data
                        if (ticket['Age'] || ticket['Sex'] || ticket['Regulation Area'] || 
                            ticket['Problem Encountered'] || ticket['Response Time'] > 0 || 
                            ticket['Average Performance'] > 0 || ticket['Personnel']) {
                            closedTicketsData.push(ticket);
                        }
                    }
                }
                
                console.log('Loaded', closedTicketsData.length, 'closed tickets');
                
                if (closedTicketsData.length > 0) {
                    // Analyze data
                    analyzeData();
                    
                    // NEW: Analyze personnel performance
                    analyzePersonnelPerformance();
                    
                    // Update last updated timestamp
                    document.getElementById('lastUpdated').textContent = new Date().toLocaleString();
                    
                    // Hide loading, show charts
                    loading.style.display = 'none';
                    
                    // Create all visualizations
                    createSummaryStats();
                    createDemographicsChart();
                    createRegulationAreaChart();
                    createProblemTypeChart();
                    createResponseTimeChart();
                    createPerformanceChart();
                    createCorrelationChart();
                    
                    // NEW: Create personnel performance section
                    createPersonnelPerformance();
                    personnelSection.style.display = 'block';
                    
                } else {
                    throw new Error('No valid closed ticket data found in sheet');
                }
                
            } catch (err) {
                console.error('Error loading closed tickets:', err);
                document.getElementById('errorMessage').textContent = err.message;
                loading.style.display = 'none';
                error.style.display = 'flex';
            }
        }
        
        // Parse CSV row with proper handling of quoted fields
        function parseCSVRow(row) {
            const cols = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < row.length; i++) {
                const char = row[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    cols.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            
            cols.push(current.trim());
            return cols;
        }
        
        // Analyze the data to create summary statistics
        function analyzeData() {
            analyticsSummary = {
                totalTickets: closedTicketsData.length,
                
                // Age analysis
                ageGroups: {},
                averageAge: 0,
                
                // Gender analysis
                genderCount: { Male: 0, Female: 0 },
                
                // Regulation area analysis
                regulationAreas: {},
                
                // Problem type analysis
                problemTypes: {},
                
                // Response time analysis
                responseTimeCategories: {
                    'Less than 1 hour': { 
                        label: 'Less than 1 hour', 
                        description: '<1 hr',
                        count: 0,
                        numericValue: 0.5
                    },
                    'Within the day': { 
                        label: 'Within the day', 
                        description: '1-8 hrs',
                        count: 0,
                        numericValue: 4.5
                    },
                    'The next day': { 
                        label: 'The next day', 
                        description: '8-16 hrs',
                        count: 0,
                        numericValue: 12
                    },
                    'More than 2 days': { 
                        label: 'More than 2 days', 
                        description: '>16 hrs',
                        count: 0,
                        numericValue: 24
                    }
                },
                
                // Response time numeric stats
                responseTimeStats: {
                    min: Infinity,
                    max: 0,
                    avg: 0,
                    total: 0
                },
                
                // Performance analysis
                performanceStats: {
                    min: Infinity,
                    max: 0,
                    avg: 0,
                    total: 0
                }
            };
            
            let ageSum = 0;
            let validAgeCount = 0;
            let responseTimeSum = 0;
            let validResponseTimeCount = 0;
            let performanceSum = 0;
            let validPerformanceCount = 0;
            
            // Process each ticket
            closedTicketsData.forEach(ticket => {
                // Age analysis
                if (ticket.Age) {
                    const age = parseInt(ticket.Age);
                    if (!isNaN(age)) {
                        ageSum += age;
                        validAgeCount++;
                        
                        let ageGroup;
                        if (age <= 25) ageGroup = '18-25';
                        else if (age <= 35) ageGroup = '26-35';
                        else if (age <= 45) ageGroup = '36-45';
                        else if (age <= 55) ageGroup = '46-55';
                        else ageGroup = '56+';
                        
                        analyticsSummary.ageGroups[ageGroup] = (analyticsSummary.ageGroups[ageGroup] || 0) + 1;
                    }
                }
                
                // Gender analysis
                if (ticket.Sex) {
                    const gender = ticket.Sex.trim().toLowerCase();
                    if (gender === 'male' || gender === 'm') {
                        analyticsSummary.genderCount.Male++;
                    } else if (gender === 'female' || gender === 'f') {
                        analyticsSummary.genderCount.Female++;
                    }
                }
                
                // Regulation area analysis
                if (ticket['Regulation Area']) {
                    const area = ticket['Regulation Area'].trim();
                    analyticsSummary.regulationAreas[area] = (analyticsSummary.regulationAreas[area] || 0) + 1;
                }
                
                // Problem type analysis
                if (ticket['Problem Encountered']) {
                    const problem = ticket['Problem Encountered'].trim();
                    analyticsSummary.problemTypes[problem] = (analyticsSummary.problemTypes[problem] || 0) + 1;
                }
                
                // Response time analysis
                const responseTime = ticket['Response Time'];
                if (responseTime > 0) {
                    // Update category counts based on text category
                    const categoryInfo = ticket['Response Time Category'];
                    if (categoryInfo) {
                        if (categoryInfo.label === 'Less than 1 hour') {
                            analyticsSummary.responseTimeCategories['Less than 1 hour'].count++;
                        } else if (categoryInfo.label === 'Within the day') {
                            analyticsSummary.responseTimeCategories['Within the day'].count++;
                        } else if (categoryInfo.label === 'The next day') {
                            analyticsSummary.responseTimeCategories['The next day'].count++;
                        } else if (categoryInfo.label === 'More than 2 days') {
                            analyticsSummary.responseTimeCategories['More than 2 days'].count++;
                        }
                    }
                    
                    // Update numeric stats
                    responseTimeSum += responseTime;
                    validResponseTimeCount++;
                    
                    if (responseTime < analyticsSummary.responseTimeStats.min) {
                        analyticsSummary.responseTimeStats.min = responseTime;
                    }
                    if (responseTime > analyticsSummary.responseTimeStats.max) {
                        analyticsSummary.responseTimeStats.max = responseTime;
                    }
                }
                
                // Performance analysis
                if (ticket['Average Performance'] > 0) {
                    performanceSum += ticket['Average Performance'];
                    validPerformanceCount++;
                    
                    if (ticket['Average Performance'] < analyticsSummary.performanceStats.min) {
                        analyticsSummary.performanceStats.min = ticket['Average Performance'];
                    }
                    if (ticket['Average Performance'] > analyticsSummary.performanceStats.max) {
                        analyticsSummary.performanceStats.max = ticket['Average Performance'];
                    }
                }
            });
            
            // Calculate averages
            if (validAgeCount > 0) {
                analyticsSummary.averageAge = Math.round(ageSum / validAgeCount);
            }
            
            if (validResponseTimeCount > 0) {
                analyticsSummary.responseTimeStats.avg = responseTimeSum / validResponseTimeCount;
                analyticsSummary.responseTimeStats.total = responseTimeSum;
            }
            
            if (validPerformanceCount > 0) {
                analyticsSummary.performanceStats.avg = performanceSum / validPerformanceCount;
                analyticsSummary.performanceStats.total = performanceSum;
            }
            
            console.log('Analytics summary:', analyticsSummary);
        }
        
        // NEW: Analyze personnel performance
        function analyzePersonnelPerformance() {
            personnelPerformance = {};
            
            closedTicketsData.forEach(ticket => {
                const personnelName = ticket.Personnel;
                if (!personnelName) return;
                
                if (!personnelPerformance[personnelName]) {
                    personnelPerformance[personnelName] = {
                        name: personnelName,
                        totalTickets: 0,
                        performanceSum: 0,
                        responseTimeSum: 0,
                        performanceTickets: 0,
                        responseTimeTickets: 0,
                        responseTimes: [],
                        regulationAreas: {},
                        problemTypes: {}
                    };
                }
                
                const personnel = personnelPerformance[personnelName];
                personnel.totalTickets++;
                
                // Track performance
                if (ticket['Average Performance'] > 0) {
                    personnel.performanceSum += ticket['Average Performance'];
                    personnel.performanceTickets++;
                }
                
                // Track response time
                if (ticket['Response Time'] > 0) {
                    personnel.responseTimeSum += ticket['Response Time'];
                    personnel.responseTimeTickets++;
                    personnel.responseTimes.push(ticket['Response Time']);
                }
                
                // Track regulation areas
                if (ticket['Regulation Area']) {
                    const area = ticket['Regulation Area'].trim();
                    personnel.regulationAreas[area] = (personnel.regulationAreas[area] || 0) + 1;
                }
                
                // Track problem types
                if (ticket['Problem Encountered']) {
                    const problem = ticket['Problem Encountered'].trim();
                    personnel.problemTypes[problem] = (personnel.problemTypes[problem] || 0) + 1;
                }
            });
            
            // Calculate averages for each personnel
            Object.values(personnelPerformance).forEach(personnel => {
                personnel.averagePerformance = personnel.performanceTickets > 0 
                    ? personnel.performanceSum / personnel.performanceTickets 
                    : 0;
                
                personnel.averageResponseTime = personnel.responseTimeTickets > 0 
                    ? personnel.responseTimeSum / personnel.responseTimeTickets 
                    : 0;
                
                personnel.performanceCategory = getPerformanceCategory(personnel.averagePerformance);
                
                // Find most common regulation area
                const regulationEntries = Object.entries(personnel.regulationAreas);
                personnel.primaryRegulationArea = regulationEntries.length > 0
                    ? regulationEntries.sort((a, b) => b[1] - a[1])[0][0]
                    : 'N/A';
                
                // Find most common problem type
                const problemEntries = Object.entries(personnel.problemTypes);
                personnel.primaryProblemType = problemEntries.length > 0
                    ? problemEntries.sort((a, b) => b[1] - a[1])[0][0]
                    : 'N/A';
            });
            
            console.log('Personnel performance analysis:', personnelPerformance);
        }
        
        // NEW: Create personnel performance cards and table
        function createPersonnelPerformance() {
            const personnelGrid = document.getElementById('personnelGrid');
            const performanceTableBody = document.getElementById('performanceTableBody');
            const personnelCount = document.getElementById('personnelCount');
            
            // Convert personnel data to array and sort by rating
            let personnelArray = Object.values(personnelPerformance);
            
            // Sort by average rating (descending)
            personnelArray.sort((a, b) => b.averagePerformance - a.averagePerformance);
            
            // Update count
            personnelCount.textContent = personnelArray.length;
            
            // Clear previous content
            personnelGrid.innerHTML = '';
            performanceTableBody.innerHTML = '';
            
            // Create personnel cards
            personnelArray.forEach((personnel, index) => {
                const cardId = `personnel-card-${index}`;
                const chartId = `personnel-chart-${index}`;
                
                // Create card
                const cardHTML = `
                    <div class="personnel-card">
                        <div class="personnel-card-header">
                            <div class="personnel-avatar">
                                ${getInitials(personnel.name)}
                            </div>
                            <div class="personnel-info">
                                <h3>${personnel.name}</h3>
                                <p>Primary Area: ${personnel.primaryRegulationArea}</p>
                            </div>
                        </div>
                        
                        <div class="personnel-stats">
                            <div class="personnel-stat">
                                <div class="personnel-stat-value">${personnel.averagePerformance.toFixed(1)}</div>
                                <div class="personnel-stat-label">Avg Rating</div>
                                <div class="personnel-performance-bar">
                                    <div class="personnel-performance-fill" 
                                         style="width: ${(personnel.averagePerformance / 5) * 100}%; 
                                                background-color: ${personnel.averagePerformance >= 4 ? '#38a169' : 
                                                                   personnel.averagePerformance >= 3 ? '#d69e2e' : '#e53e3e'};">
                                    </div>
                                </div>
                                <div class="personnel-rating">
                                    <div class="stars">
                                        ${getStarsHTML(personnel.averagePerformance)}
                                    </div>
                                    <span class="rating-badge ${personnel.performanceCategory.class}">
                                        ${personnel.performanceCategory.label}
                                    </span>
                                </div>
                            </div>
                            
                            <div class="personnel-stat">
                                <div class="personnel-stat-value">${personnel.averageResponseTime.toFixed(1)}h</div>
                                <div class="personnel-stat-label">Avg Response Time</div>
                                <div class="personnel-stat-label" style="margin-top: 5px;">
                                    ${personnel.responseTimeTickets} tickets
                                </div>
                            </div>
                        </div>
                        
                        <div class="personnel-chart-mini" id="${chartId}"></div>
                        
                        <div class="personnel-tickets">
                            <div><strong>${personnel.totalTickets}</strong> total tickets handled</div>
                            <div>Most common issue: ${personnel.primaryProblemType.substring(0, 30)}${personnel.primaryProblemType.length > 30 ? '...' : ''}</div>
                        </div>
                    </div>
                `;
                
                personnelGrid.innerHTML += cardHTML;
                
                // Create mini chart for response times
                createMiniResponseChart(personnel, chartId);
                
                // Add to table
                const rowHTML = `
                    <tr>
                        <td>
                            <div class="rank ${index < 3 ? `rank-${index + 1}` : ''}">
                                ${index + 1}
                            </div>
                        </td>
                        <td><strong>${personnel.name}</strong></td>
                        <td>${personnel.averagePerformance.toFixed(1)}</td>
                        <td>${personnel.averageResponseTime.toFixed(1)} hours</td>
                        <td>${personnel.totalTickets}</td>
                        <td>
                            <span class="rating-badge ${personnel.performanceCategory.class}">
                                ${personnel.performanceCategory.label}
                            </span>
                        </td>
                    </tr>
                `;
                
                performanceTableBody.innerHTML += rowHTML;
            });
            
            // Add event listeners for filters
            document.getElementById('sortPersonnel').addEventListener('change', function() {
                sortAndFilterPersonnel();
            });
            
            document.getElementById('filterPersonnel').addEventListener('change', function() {
                sortAndFilterPersonnel();
            });
        }
        
        // NEW: Sort and filter personnel
        function sortAndFilterPersonnel() {
            const sortBy = document.getElementById('sortPersonnel').value;
            const filterBy = document.getElementById('filterPersonnel').value;
            
            let personnelArray = Object.values(personnelPerformance);
            
            // Apply filter
            switch(filterBy) {
                case 'top10':
                    personnelArray = personnelArray.slice(0, 10);
                    break;
                case 'top20':
                    personnelArray = personnelArray.slice(0, 20);
                    break;
                case 'rating4':
                    personnelArray = personnelArray.filter(p => p.averagePerformance >= 4.0);
                    break;
                case 'rating3':
                    personnelArray = personnelArray.filter(p => p.averagePerformance >= 3.0 && p.averagePerformance < 4.0);
                    break;
                case 'rating2':
                    personnelArray = personnelArray.filter(p => p.averagePerformance < 3.0);
                    break;
                // 'all' - keep all personnel
            }
            
            // Apply sort
            switch(sortBy) {
                case 'rating-desc':
                    personnelArray.sort((a, b) => b.averagePerformance - a.averagePerformance);
                    break;
                case 'rating-asc':
                    personnelArray.sort((a, b) => a.averagePerformance - b.averagePerformance);
                    break;
                case 'response-asc':
                    personnelArray.sort((a, b) => a.averageResponseTime - b.averageResponseTime);
                    break;
                case 'response-desc':
                    personnelArray.sort((a, b) => b.averageResponseTime - a.averageResponseTime);
                    break;
                case 'tickets-desc':
                    personnelArray.sort((a, b) => b.totalTickets - a.totalTickets);
                    break;
                case 'tickets-asc':
                    personnelArray.sort((a, b) => a.totalTickets - b.totalTickets);
                    break;
            }
            
            // Update display
            updatePersonnelDisplay(personnelArray);
        }
        
        // NEW: Update personnel display after sorting/filtering
        function updatePersonnelDisplay(personnelArray) {
            const personnelGrid = document.getElementById('personnelGrid');
            const performanceTableBody = document.getElementById('performanceTableBody');
            const personnelCount = document.getElementById('personnelCount');
            
            // Update count
            personnelCount.textContent = personnelArray.length;
            
            // Clear previous content
            personnelGrid.innerHTML = '';
            performanceTableBody.innerHTML = '';
            
            // Create updated cards and table rows
            personnelArray.forEach((personnel, index) => {
                const cardId = `personnel-card-${index}`;
                const chartId = `personnel-chart-${index}`;
                
                // Create card
                const cardHTML = `
                    <div class="personnel-card">
                        <div class="personnel-card-header">
                            <div class="personnel-avatar">
                                ${getInitials(personnel.name)}
                            </div>
                            <div class="personnel-info">
                                <h3>${personnel.name}</h3>
                                <p>Primary Area: ${personnel.primaryRegulationArea}</p>
                            </div>
                        </div>
                        
                        <div class="personnel-stats">
                            <div class="personnel-stat">
                                <div class="personnel-stat-value">${personnel.averagePerformance.toFixed(1)}</div>
                                <div class="personnel-stat-label">Avg Rating</div>
                                <div class="personnel-performance-bar">
                                    <div class="personnel-performance-fill" 
                                         style="width: ${(personnel.averagePerformance / 5) * 100}%; 
                                                background-color: ${personnel.averagePerformance >= 4 ? '#38a169' : 
                                                                   personnel.averagePerformance >= 3 ? '#d69e2e' : '#e53e3e'};">
                                    </div>
                                </div>
                                <div class="personnel-rating">
                                    <div class="stars">
                                        ${getStarsHTML(personnel.averagePerformance)}
                                    </div>
                                    <span class="rating-badge ${personnel.performanceCategory.class}">
                                        ${personnel.performanceCategory.label}
                                    </span>
                                </div>
                            </div>
                            
                            <div class="personnel-stat">
                                <div class="personnel-stat-value">${personnel.averageResponseTime.toFixed(1)}h</div>
                                <div class="personnel-stat-label">Avg Response Time</div>
                                <div class="personnel-stat-label" style="margin-top: 5px;">
                                    ${personnel.responseTimeTickets} tickets
                                </div>
                            </div>
                        </div>
                        
                        <div class="personnel-chart-mini" id="${chartId}"></div>
                        
                        <div class="personnel-tickets">
                            <div><strong>${personnel.totalTickets}</strong> total tickets handled</div>
                            <div>Most common issue: ${personnel.primaryProblemType.substring(0, 30)}${personnel.primaryProblemType.length > 30 ? '...' : ''}</div>
                        </div>
                    </div>
                `;
                
                personnelGrid.innerHTML += cardHTML;
                
                // Create mini chart for response times
                createMiniResponseChart(personnel, chartId);
                
                // Add to table
                const rowHTML = `
                    <tr>
                        <td>
                            <div class="rank ${index < 3 ? `rank-${index + 1}` : ''}">
                                ${index + 1}
                            </div>
                        </td>
                        <td><strong>${personnel.name}</strong></td>
                        <td>${personnel.averagePerformance.toFixed(1)}</td>
                        <td>${personnel.averageResponseTime.toFixed(1)} hours</td>
                        <td>${personnel.totalTickets}</td>
                        <td>
                            <span class="rating-badge ${personnel.performanceCategory.class}">
                                ${personnel.performanceCategory.label}
                            </span>
                        </td>
                    </tr>
                `;
                
                performanceTableBody.innerHTML += rowHTML;
            });
        }
        
        // Create summary statistics cards (existing function - keeping it as is)
        function createSummaryStats() {
            const statsSummary = document.getElementById('statsSummary');
            
            const responseCategories = analyticsSummary.responseTimeCategories;
            const totalWithResponseTime = 
                responseCategories['Less than 1 hour'].count +
                responseCategories['Within the day'].count +
                responseCategories['The next day'].count +
                responseCategories['More than 2 days'].count;
            
            const categoryArray = Object.values(responseCategories);
            const mostCommonCategory = categoryArray.reduce((prev, current) => 
                (prev.count > current.count) ? prev : current
            );
            
            const lessThan1HourPercentage = totalWithResponseTime > 0 ? 
                Math.round((responseCategories['Less than 1 hour'].count / totalWithResponseTime) * 100) : 0;
            
            // NEW: Count unique personnel
            const uniquePersonnelCount = Object.keys(personnelPerformance).length;
            
            const statsCards = [
                {
                    icon: 'fas fa-ticket-alt',
                    iconColor: '#4a6fa5',
                    title: 'Total Closed Tickets',
                    value: analyticsSummary.totalTickets,
                    subtitle: 'Successfully resolved requests'
                },
                {
                    icon: 'fas fa-user-friends',
                    iconColor: '#38a169',
                    title: 'Average Age',
                    value: analyticsSummary.averageAge,
                    subtitle: 'Years'
                },
                {
                    icon: 'fas fa-venus-mars',
                    iconColor: '#d53f8c',
                    title: 'Sex Ratio',
                    value: `${analyticsSummary.genderCount.Male}:${analyticsSummary.genderCount.Female}`,
                    subtitle: 'Male:Female'
                },
                {
                    icon: 'fas fa-user-tie',
                    iconColor: '#805ad5',
                    title: 'Active Personnel',
                    value: uniquePersonnelCount,
                    subtitle: 'Unique staff members'
                },
                {
                    icon: 'fas fa-bolt',
                    iconColor: '#38a169',
                    title: 'Most Common Response',
                    value: mostCommonCategory.label.split(' ')[0],
                    subtitle: `${mostCommonCategory.count} tickets`
                },
                {
                    icon: 'fas fa-star',
                    iconColor: '#e53e3e',
                    title: 'Avg Performance',
                    value: analyticsSummary.performanceStats.avg.toFixed(1),
                    subtitle: 'Out of 5'
                },
                {
                    icon: 'fas fa-percentage',
                    iconColor: '#4a6fa5',
                    title: '<1 Hour Response Rate',
                    value: `${lessThan1HourPercentage}%`,
                    subtitle: 'Immediate resolution'
                }
            ];
            
            statsSummary.innerHTML = statsCards.map(card => `
                <div class="stat-card">
                    <div class="stat-icon" style="background-color: ${card.iconColor}20; color: ${card.iconColor};">
                        <i class="${card.icon}"></i>
                    </div>
                    <div class="stat-content">
                        <h3>${card.title}</h3>
                        <div class="stat-value">${card.value}</div>
                        <div class="stat-subtitle">${card.subtitle}</div>
                    </div>
                </div>
            `).join('');
        }
        
        // The rest of your existing chart creation functions remain the same...
        // (Demographics, Regulation Area, Problem Types, Response Time, Performance, Correlation charts)
        // These functions are unchanged from your original code

        // Initialize the dashboard
        document.addEventListener('DOMContentLoaded', function() {
            loadClosedTicketsData();
            
            // Auto-refresh every 10 minutes
            setInterval(loadClosedTicketsData, 10 * 60 * 1000);
        });
    </script>
</body>
</html>
